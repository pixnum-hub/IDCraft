<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IDCraft - ID Photo Maker</title>
<style>
:root{
 --bg:#eef2f7;
 --card:rgba(255,255,255,.75);
 --text:#000;
 --accent:#2563eb;
 --guide:rgba(38,198,218,0.6);
}
body.dark{
 --bg:#0b0f15;
 --card:rgba(20,20,25,.85);
 --text:#fff;
 --guide:rgba(38,198,218,0.8);
}
body{
 margin:0;font-family:system-ui;
 background:var(--bg);
 display:flex;justify-content:center;
 color:var(--text);
}
.app{width:100%;max-width:420px;padding:12px}
.card{
 background:var(--card);
 backdrop-filter:blur(16px);
 border-radius:18px;padding:14px;
 box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.top{display:flex;justify-content:space-between;align-items:center;}
.toggle{width:38px;height:38px;border-radius:50%;border:none;font-size:18px;}
.editor-wrap{position:relative;margin-top:10px;}
canvas{width:100%;background:#ccc;border-radius:10px;touch-action:none;}
.handle{position:absolute;width:16px;height:16px;background:var(--accent);border:2px solid #fff;border-radius:4px;touch-action:none;}
.controls>*{width:100%;margin:8px 0}
button,input{padding:10px;border-radius:10px;border:none;}
.preview img{width:100%;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);}
footer{text-align:center;font-size:12px;margin-top:10px;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div class="app">
<div class="card">
<div class="top">
<h3>IDCraft</h3>
<button class="toggle" onclick="toggleDark()">ðŸŒ™</button>
</div>

<input type="file" accept="image/*" onchange="loadImage(event)">

<div class="editor-wrap">
<canvas id="editor" width="360" height="450"></canvas>
<div id="handles"></div>
</div>

<div class="controls">
<input type="range" min="0.2" max="3" step="0.01" value="1" oninput="setZoom(this.value)">
<button onclick="fitFace()">Fit Face</button>
<button onclick="generate()">Generate</button>
<button onclick="generateA4()">A4 Preview</button>
<button onclick="downloadPDF()">Download PDF</button>
<input type="color" id="bgColor" value="#ffffff" onchange="updateBgColor()">
<button onclick="resetAll()">Reset All</button>
</div>

<div class="preview">
<img id="outputPreview">
</div>
<canvas id="previewCanvas" hidden></canvas>
</div>
<footer>Â© Manik Roy 2025. All Rights Reserved.</footer>
</div>

<script>
const editor = document.getElementById("editor");
const ctx = editor.getContext("2d");
const handlesDiv = document.getElementById("handles");
const outputPreview = document.getElementById("outputPreview");
const previewCanvas = document.getElementById("previewCanvas");

let img=null, zoom=1, imgX=0, imgY=0;
let draggingImg=false, draggingCrop=false, activeHandle=null;
let startX=0, startY=0, cropStartX=0, cropStartY=0;
let bgColor="#ffffff";
let lastDist=0;

const cropRatio = 35/45; 
let crop={x:40,y:40,w:280,h:280/cropRatio};

const handleNames=["nw","n","ne","e","se","s","sw","w"];
handleNames.forEach(n=>{
 const h=document.createElement("div");
 h.className="handle";
 h.dataset.h=n;
 handlesDiv.appendChild(h);
});

function toggleDark(){document.body.classList.toggle("dark");}

function loadImage(e){
 img=new Image();
 img.onload=()=>{
  zoom=calcFitZoom();
  centerImageInCrop();
  draw();
 };
 img.src=URL.createObjectURL(e.target.files[0]);
}

function calcFitZoom(){ return Math.min(crop.w/img.width, crop.h/img.height); }
function centerImageInCrop(){ imgX=crop.x+(crop.w-img.width*zoom)/2; imgY=crop.y+(crop.h-img.height*zoom)/2; }

function setZoom(z){ if(!img) return; zoom=z; centerImageInCrop(); draw(); }

function fitFace(){
 if(!img) return;
 const zoomX=crop.w/img.width;
 const zoomY=crop.h/img.height;
 zoom=Math.max(zoomX, zoomY);
 imgX=crop.x+(crop.w-img.width*zoom)/2;
 imgY=crop.y+(crop.h-img.height*zoom)/2;
 draw();
}

function updateBgColor(){
 bgColor=document.getElementById("bgColor").value;
 draw();
}

function resetAll(){
 img=null; zoom=1; imgX=0; imgY=0;
 crop={x:40,y:40,w:280,h:280/cropRatio};
 bgColor="#ffffff"; document.getElementById("bgColor").value="#ffffff";
 outputPreview.src="";
 draw();
}

function isInsideCrop(x,y){ return x>=crop.x&&x<=crop.x+crop.w&&y>=crop.y&&y<=crop.y+crop.h; }

function draw(){
 ctx.fillStyle=bgColor;
 ctx.fillRect(0,0,editor.width,editor.height);
 if(!img) return;
 ctx.drawImage(img,imgX,imgY,img.width*zoom,img.height*zoom);
 ctx.strokeStyle="#2563eb"; ctx.lineWidth=2;
 ctx.strokeRect(crop.x,crop.y,crop.w,crop.h);
 ctx.strokeStyle="var(--guide)"; ctx.lineWidth=2;
 ctx.beginPath();
 ctx.moveTo(crop.x, crop.y+crop.h*0.35);
 ctx.lineTo(crop.x+crop.w, crop.y+crop.h*0.35);
 ctx.moveTo(crop.x, crop.y+crop.h*0.85);
 ctx.lineTo(crop.x+crop.w, crop.y+crop.h*0.85);
 ctx.stroke();
 updateHandles();
}

function updateHandles(){
 const p={
  nw:[crop.x,crop.y], n:[crop.x+crop.w/2,crop.y], ne:[crop.x+crop.w,crop.y],
  e:[crop.x+crop.w,crop.y+crop.h/2], se:[crop.x+crop.w,crop.y+crop.h],
  s:[crop.x+crop.w/2,crop.y+crop.h], sw:[crop.x,crop.y+crop.h],
  w:[crop.x,crop.y+crop.h/2]
 };
 document.querySelectorAll(".handle").forEach(h=>{
  const [x,y]=p[h.dataset.h];
  h.style.left=(editor.offsetLeft+x-8)+"px";
  h.style.top=(editor.offsetTop+y-8)+"px";
 });
}

// --- POINTER & TOUCH EVENTS ---
editor.addEventListener("pointerdown",e=>{
 const r=editor.getBoundingClientRect();
 const x=e.clientX-r.left; const y=e.clientY-r.top;
 if(isInsideCrop(x,y)){draggingCrop=true; cropStartX=x-crop.x; cropStartY=y-crop.y; return;}
 draggingImg=true; startX=e.clientX-imgX; startY=e.clientY-imgY;
});
editor.addEventListener("pointermove",e=>{
 const r=editor.getBoundingClientRect();
 const x=e.clientX-r.left; const y=e.clientY-r.top;
 if(draggingCrop){ crop.x=x-cropStartX; crop.y=y-cropStartY;
  crop.x=Math.max(0,Math.min(editor.width-crop.w,crop.x));
  crop.y=Math.max(0,Math.min(editor.height-crop.h,crop.y));
  centerImageInCrop(); draw(); return;}
 if(draggingImg){ imgX=e.clientX-startX; imgY=e.clientY-startY; draw(); }
});
editor.addEventListener("pointerup",()=>{draggingImg=false; draggingCrop=false;});

document.querySelectorAll(".handle").forEach(h=>{
 h.addEventListener("pointerdown",e=>{
  e.stopPropagation(); activeHandle=h.dataset.h; startX=e.clientX; startY=e.clientY;
 });
});

window.addEventListener("pointermove",e=>{
 if(!activeHandle||!img) return;
 const dx=e.clientX-startX; const dy=e.clientY-startY;
 if(activeHandle.includes("e")) crop.w+=dx;
 if(activeHandle.includes("s")) crop.h+=dy;
 if(activeHandle.includes("w")){crop.x+=dx; crop.w-=dx;}
 if(activeHandle.includes("n")){crop.y+=dy; crop.h-=dy;}
 crop.h=crop.w/cropRatio; crop.w=Math.max(150,crop.w); crop.h=Math.max(200,crop.h);
 zoom=calcFitZoom(); centerImageInCrop();
 startX=e.clientX; startY=e.clientY; draw();
});
window.addEventListener("pointerup",()=>activeHandle=null);

// --- TOUCH SUPPORT ---
editor.addEventListener("touchstart", e => {
 if (!img) return;
 if (e.touches.length === 1) {
   const r = editor.getBoundingClientRect();
   const x = e.touches[0].clientX - r.left;
   const y = e.touches[0].clientY - r.top;
   if(isInsideCrop(x,y)){draggingCrop=true; cropStartX=x-crop.x; cropStartY=y-crop.y;} 
   else {draggingImg=true; startX=e.touches[0].clientX-imgX; startY=e.touches[0].clientY-imgY;}
 }
});
editor.addEventListener("touchmove", e => {
 if(!img) return;
 e.preventDefault();
 if(e.touches.length===1){
   const r=editor.getBoundingClientRect();
   const x=e.touches[0].clientX-r.left; const y=e.touches[0].clientY-r.top;
   if(draggingCrop){ crop.x=x-cropStartX; crop.y=y-cropStartY;
     crop.x=Math.max(0,Math.min(editor.width-crop.w,crop.x));
     crop.y=Math.max(0,Math.min(editor.height-crop.h,crop.y));
     centerImageInCrop(); draw();}
   else if(draggingImg){ imgX=e.touches[0].clientX-startX; imgY=e.touches[0].clientY-startY; draw();}
 }
 if(e.touches.length===2){
   const dx=e.touches[0].clientX-e.touches[1].clientX;
   const dy=e.touches[0].clientY-e.touches[1].clientY;
   const dist=Math.sqrt(dx*dx+dy*dy);
   if(lastDist>0){ let scale=dist/lastDist; zoom*=scale; centerImageInCrop(); draw();}
   lastDist=dist;
 }
});
editor.addEventListener("touchend",e=>{if(e.touches.length<1){draggingImg=false; draggingCrop=false; activeHandle=null; lastDist=0;}});

document.querySelectorAll(".handle").forEach(h=>{
 h.addEventListener("touchstart", e=>{
   e.stopPropagation();
   activeHandle=h.dataset.h;
   startX=e.touches[0].clientX; startY=e.touches[0].clientY;
 });
});

window.addEventListener("touchmove", e=>{
 if(!activeHandle||!img||e.touches.length>1) return;
 const dx=e.touches[0].clientX-startX; const dy=e.touches[0].clientY-startY;
 if(activeHandle.includes("e")) crop.w+=dx;
 if(activeHandle.includes("s")) crop.h+=dy;
 if(activeHandle.includes("w")){crop.x+=dx; crop.w-=dx;}
 if(activeHandle.includes("n")){crop.y+=dy; crop.h-=dy;}
 crop.h=crop.w/cropRatio; crop.w=Math.max(150,crop.w); crop.h=Math.max(200,crop.h);
 zoom=calcFitZoom(); centerImageInCrop();
 startX=e.touches[0].clientX; startY=e.touches[0].clientY;
 draw();
});
window.addEventListener("touchend", e=>{if(e.touches.length<1) activeHandle=null;});

// --- GENERATE & PDF ---
function generate(){
 if(!img) return;
 const c=previewCanvas; const p=c.getContext("2d");
 const outputWidth=600; const outputHeight=800; c.width=outputWidth; c.height=outputHeight;
 p.fillStyle=bgColor; p.fillRect(0,0,outputWidth,outputHeight);
 const sx=(crop.x-imgX)/zoom; const sy=(crop.y-imgY)/zoom;
 const sw=crop.w/zoom; const sh=crop.h/zoom;
 const destRatio=sw/sh; let dw=outputWidth; let dh=outputHeight;
 if(dw/dh>destRatio){ dw=dh*destRatio;} else { dh=dw/destRatio;}
 const dx=(outputWidth-dw)/2; const dy=(outputHeight-dh)/2;
 p.drawImage(img,sx,sy,sw,sh,dx,dy,dw,dh);
 outputPreview.src=c.toDataURL("image/jpeg",1);
}

function generateA4(){
 if(!img) return;
 const c=previewCanvas; const p=c.getContext("2d");
 c.width=2480; c.height=3508; p.fillStyle=bgColor; p.fillRect(0,0,c.width,c.height);
 const pw=600; const ph=800;
 const sx=(crop.x-imgX)/zoom; const sy=(crop.y-imgY)/zoom;
 const sw=crop.w/zoom; const sh=crop.h/zoom;
 const destRatio=sw/sh; let dw=pw; let dh=ph; if(dw/dh>destRatio){dw=dh*destRatio;}else{dh=dw/destRatio;}
 for(let r=0;r<4;r++){for(let cIdx=0;cIdx<2;cIdx++){
   const x=50+cIdx*(pw+50)+(pw-dw)/2; const y=50+r*(ph+50)+(ph-dh)/2;
   p.drawImage(img,sx,sy,sw,sh,x,y,dw,dh);
 }}
 outputPreview.src=c.toDataURL("image/jpeg",1);
}

function downloadPDF(){
 if(!img) return;
 const { jsPDF }=window.jspdf;
 const pdf=new jsPDF({orientation:"portrait",unit:"px",format:[2480,3508]});
 const sx=(crop.x-imgX)/zoom; const sy=(crop.y-imgY)/zoom;
 const sw=crop.w/zoom; const sh=crop.h/zoom;
 const pw=600; const ph=800;
 const destRatio=sw/sh; let dw=pw; let dh=ph; if(dw/dh>destRatio){dw=dh*destRatio;}else{dh=dw/destRatio;}
 for(let r=0;r<4;r++){for(let cIdx=0;cIdx<2;cIdx++){
   const dx=50+cIdx*(pw+50)+(pw-dw)/2; const dy=50+r*(ph+50)+(ph-dh)/2;
   const tempCanvas=document.createElement("canvas");
   tempCanvas.width=dw; tempCanvas.height=dh;
   const tctx=tempCanvas.getContext("2d");
   tctx.fillStyle=bgColor; tctx.fillRect(0,0,dw,dh);
   tctx.drawImage(img,sx,sy,sw,sh,0,0,dw,dh);
   pdf.addImage(tempCanvas.toDataURL("image/jpeg",1),'JPEG',dx,dy,dw,dh);
 }}
 pdf.save("ID_Photos.pdf");
}
</script>
</body>
</html>
